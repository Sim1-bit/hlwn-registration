---
import LanguageSwitcher from './LanguageSwitcher.astro'

const { settings, registration, lang } = Astro.props
---
<section>
  <LanguageSwitcher lang={lang} />
  { registration.title && <h2 class="bs-h2 text-center" set:html={ registration.title } />}
  <br>

  <!-- Form di registrazione -->
   <form id="form" data-registration={JSON.stringify(registration).replace(/</g, '\\u003c')}>
      <label>
        {registration.name} : <input type="text" name="name" placeholder={registration.placeholders.name} required />
      </label>
      <p class="error" id="nameError"></p>

      <label>
        {registration.surname} : <input type="text" name="surname" placeholder={registration.placeholders.surname} required />
      </label>
      <p class="error" id="surnameError"></p>

      <label>
        {registration.email} : <input type="email" name="email" placeholder={registration.placeholders.email} required />
      </label>
      <p class="error" id="emailError"></p>

      <label>
        {registration.password} : <input type="password" name="password" placeholder={registration.placeholders.password} required />
      </label>
      <p class="error" id="pwdError"></p>

      <label>
        {registration.confirmPassword} : <input type="password" name="confirmPassword" placeholder={registration.placeholders.confirmPassword} required />
      </label>
      <p class="error" id="CpwdError"></p>

      <button id="btn">{registration.registerButton}</button>
      <p class="error" id="registerError"></p>
  </form>

</section>

<script is:inline>
  function getDeviceId() 
  {
    // Se il browser supporta crypto.randomUUID, usalo
    if (crypto?.randomUUID) {
      return crypto.randomUUID();
    }

    // Fallback universale UUID se non disponibile
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16)
    );
  }

  const form = document.getElementById("form");
  const registration = JSON.parse(form.dataset.registration);

  form.addEventListener("submit", async (e) => {

    e.preventDefault();

    const name = form.name.value.trim();
    const surname = form.surname.value.trim();
    const email = form.email.value.trim();
    const pwd = form.password.value;
    const cPwd= form.confirmPassword.value;

    let numError = 0;
    const pName = document.getElementById("nameError");
    const pSurname = document.getElementById("surnameError");
    const pEmail = document.getElementById("emailError");
    const pPwd = document.getElementById("pwdError");
    const pCpwd = document.getElementById("CpwdError");
    const pRegisterError = document.getElementById("registerError");


    if(!name || name.length < 3)
    {
      pName.innerHTML = registration.errors.nameToShort;
      numError++;
    }
    else
    {
      pName.innerHTML = "";
    }

    if(!surname || surname.length < 3)
    {
      pSurname.innerHTML = registration.errors.surnameToShort;
      numError++;
    }
    else
    {
      pSurname.innerHTML = "";
    }

    if(!email || !email.includes("@"))
    {
      pEmail.innerHTML = registration.errors.emailInvalid;
      numError++;
    }
    else
    {
      pEmail.innerHTML = "";
    }

    const regex = /^(?=.*\d)(?=.*[^a-zA-Z0-9]).*$/;
    if (!pwd || pwd.length < 8 || !regex.test(pwd)) 
    {
      pPwd.innerHTML = registration.errors.passwordRequirements;
      numError++;
    }
    else
    {
      pPwd.innerHTML = "";
    }

    if(pwd !== cPwd)
    {
      pCpwd.innerHTML = registration.errors.passwordsDoNotMatch;
      numError++;
    }
    else
    {
      pCpwd.innerHTML = "";
    }

    if(numError !== 0)
    {
      return;
    }

    const deviceId = getDeviceId();

    const mapOBJ = {
      email: email,
      password: pwd,
      username: email,
      firstName: name,
      lastName : surname,
      deviceId: deviceId,
    };

    try 
    {
      console.log(JSON.stringify(mapOBJ));
      const response = await fetch('http://localhost:1337/api/usersv/auth/local/register', {
        method: 'POST',
        headers: {
          'origin' : 'http://localhost:4321',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(mapOBJ),
      });
      const data = await response.json();
      pRegisterError.innerHTML = registration.successMessage;
    } 
    catch (err) 
    {
      pRegisterError.innerHTML = registration.errors.emailAlreadyRegistered;
    }
  });
</script>

<style is:global>
@import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Inter:wght@400;600&display=swap');

body {
  font-family: 'Inter', sans-serif;
  background-color: linear-gradient(90deg, #D2FCFE 0%, #f9c6ceff 100%);
  color: #e6e6f0;
}

/* === CONTAINER FORM === */
section {
  max-width: 420px;
  margin: 3rem auto;
  padding: 0.5rem;
  background: linear-gradient(90deg, #D2FCFE 0%, #F9C6D8 100%);
  border-radius: 1.25rem;
}

/* === TITOLI === */
.bs-h2 {
  font-family: 'Open+Sans', cursive;
  color: #F05374;
  font-size: 2.2rem;
  text-shadow: 0 0 8px rgba(240, 83, 116, 0.6);
}

/* === LABELS === */
form label {
  margin-bottom: 1rem;
  font-weight: 600;
  font-size: 1rem;
  color: #F05374;
}

/* === INPUTS === */
form input {
  width: 100%;
  background: #FFFFFF;
  color: #5C5C5C;
  border: 1px solid rgba(240, 83, 116, 0.5);
  border-radius: 0.5rem;
  padding: 0.6rem 0.8rem;
  margin-top: 0.3rem;
  transition: all 0.25s ease;
}

/* === ERRORI FORM === */
.error {
  color: #ff4d4d;           /* rosso acceso */
  font-family: 'Courier New', Courier, monospace; /* font diverso dal body */
  font-size: 0.85rem;       /* leggermente pi√π piccolo */
  margin-top: 0.25rem;      /* spazio sopra */
  margin-bottom: 0.75rem;   /* spazio sotto */
  display: block;           /* assicurati che sia su una nuova riga */
  font-style: italic;       /* leggermente inclinato */
}

form input::placeholder {
  color: #8f8f8f;
  opacity: 0.8;
}

form input:focus {
  outline: none;
  border-color: #D2FCFE;
  box-shadow: 0 0 10px rgba(210, 252, 254, 0.6);
  background-color: #e1e1e1ff;
  transform: scale(1.02);
}

/* === BUTTON === */
button {
  width: 100%;
  margin-top: 1rem;
  background: #F05374;
  color: #FFFFFF;
  font-weight: 700;
  font-size: 1.1rem;
  border: none;
  border-radius: 0.75rem;
  padding: 0.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

button:hover {
  filter: brightness(1.1);
  transform: translateY(-2px);
  box-shadow: 0 0 20px rgba(255, 216, 51, 0.4);
}

button:active {
  transform: scale(0.97);
}

/* === ERRORI === */
.error-msg {
  font-size: 0.9rem;
  color: #ff4d4d;
  margin-top: -0.5rem;
  margin-bottom: 0.8rem;
  display: block;
  font-style: italic;
}

/* === MOBILE === */
@media (max-width: 500px) {
  section {
    margin: 2rem 1rem;
    padding: 1.5rem;
  }
  .bs-h2 {
    font-size: 1.8rem;
  }
}

</style>